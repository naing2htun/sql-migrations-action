name: Publish migrations to deployment repo

on:
  # push:
  #   branches:
  #     - main
  workflow_run:
    workflows: ["Generate Bytebase rollout plan"]
    types: [completed]

jobs:
  publish:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [qa, stg]

    permissions:
      contents: read
      # Needed for creating PRs
      pull-requests: write

    env:
      DEPLOYMENT_REPO: naing2htun/deployment
      TARGET_DIR: latitude-demo/overlays/${{ matrix.environment }}/migrations
      SERVICE_MIGRATIONS_DIR: migrations # path in the service repo
      GIT_AUTHOR_NAME: migration-bot
      GIT_AUTHOR_EMAIL: migration-bot@users.noreply.github.com

    steps:
      - name: Check out service repo
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          path: service

      - name: Find newly added SQL files in this push
        id: changed
        run: |
          # Switch to service repo
          cd ${GITHUB_WORKSPACE}/service


          # Get all filenames under migrations folder without path
          find "${SERVICE_MIGRATIONS_DIR}" -name "*.up.sql" -type f -exec basename {} \; > $RUNNER_TEMP/all_migrations.txt || true

          echo "All migration files:"
          cat $RUNNER_TEMP/all_migrations.txt

      - name: Clone deployment repo
        uses: actions/checkout@v5
        with:
          repository: ${{ env.DEPLOYMENT_REPO }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1 # only need latest commit for faster clone
          path: deployment

      - name: Create empty migration files in deployment repo
        run: |
          cd ${GITHUB_WORKSPACE}/deployment
          mkdir -p "${TARGET_DIR}"

          # Read changed files and create empty files with just the basename
          if [ -s $RUNNER_TEMP/all_migrations.txt ]; then
            while IFS= read -r filepath; do
              filename=$(basename "$filepath")
              touch "${{ env.TARGET_DIR }}/$filename"
              echo "Created empty file: ${{ env.TARGET_DIR }}/$filename"
            done < $RUNNER_TEMP/all_migrations.txt
          else
            echo "No migration files to create"
          fi

          # Commit and push
          git add "${TARGET_DIR}/"*.sql
          git status
          # Don't need to push, PR action peter-evans/create-pull-request will handle it

      - name: Create Pull Request
        id: create_pr
        uses: peter-evans/create-pull-request@v7
        with:
          path: deployment
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: migrations/${{ matrix.environment }}-${{ github.repository_owner }}-${{ github.event.repository.name }}-${{ github.run_id }}
          commit-message: "chore(db): publish migrations to ${{ matrix.environment }}"
          title: "chore(db): publish migrations to ${{ matrix.environment }}"
          body: |
            This PR publishes new DB migrations to **${{ matrix.environment }}** environment

            - **Service**: [${{ github.repository }}](https://github.com/${{ github.repository }}).
            - **Commit**: [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }}).
            - **Environment**: ${{ matrix.environment }}

            Merging this PR will trigger Bytebase to rollout the migrations to the target database(s).
          base: main
          labels: db-migration,${{ matrix.environment }}
          author: ${{ env.GIT_AUTHOR_NAME }} <${{ env.GIT_AUTHOR_EMAIL }}>
          committer: ${{ env.GIT_AUTHOR_NAME }} <${{ env.GIT_AUTHOR_EMAIL }}>
          assignees: ${{ github.actor }}
          delete-branch: true

      - name: PR Summary
        run: |
          echo "Created PR: ${{ steps.create_pr.outputs.pull-request-url }}" >> $GITHUB_STEP_SUMMARY